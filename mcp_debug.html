<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Debug Inspector</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .panel {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }
        .log-panel {
            background-color: #f8f8f8;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            border: 1px solid #ddd;
        }
        .log-entry {
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .error { color: #d9534f; }
        .success { color: #5cb85c; }
        .info { color: #5bc0de; }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #0070f3;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MCP Debug Inspector</h1>
        
        <div class="panel">
            <h2>Connection</h2>
            <div class="flex">
                <input type="text" id="base-url" value="http://localhost:3000/api/mcp" style="width: 300px;">
                <input type="text" id="session-id" value="" placeholder="Session ID (auto-generated if empty)" style="width: 300px;">
                <button id="connect-btn">Connect SSE</button>
                <button id="disconnect-btn" disabled>Disconnect</button>
            </div>
            <div id="connection-status" style="margin-top: 10px;">Status: Disconnected</div>
        </div>
        
        <div class="panel">
            <h2>Project Operations</h2>
            <div class="button-group">
                <button id="create-project-btn" disabled>Create Project</button>
                <button id="list-projects-btn" disabled>List Projects</button>
                <select id="project-select" disabled>
                    <option value="">-- Select a project --</option>
                </select>
                <button id="select-project-btn" disabled>Select Project</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>Entity Operations</h2>
            <div class="button-group">
                <button id="create-entity-btn" disabled>Create Entity</button>
                <button id="list-entities-btn" disabled>List Entities</button>
                <select id="entity-select" disabled>
                    <option value="">-- Select an entity --</option>
                </select>
                <button id="get-entity-btn" disabled>Get Entity Details</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>Custom MCP Tool</h2>
            <div class="flex" style="margin-bottom: 10px;">
                <input type="text" id="tool-name" placeholder="Tool name" style="width: 200px;">
                <input type="text" id="tool-args" placeholder='{"key": "value"}' style="width: 400px;">
                <button id="execute-tool-btn" disabled>Execute Tool</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>Event Log</h2>
            <button id="clear-log-btn">Clear Log</button>
            <div class="log-panel" id="log-output"></div>
        </div>
    </div>

    <script>
        // Main state
        let sseConnection = null;
        let sessionId = null;
        let connected = false;
        let responseHandlers = {};
        let currentProjectId = null;
        let entities = [];
        let projects = [];

        // DOM Elements
        const baseUrlInput = document.getElementById('base-url');
        const sessionIdInput = document.getElementById('session-id');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const connectionStatus = document.getElementById('connection-status');
        const logOutput = document.getElementById('log-output');
        const clearLogBtn = document.getElementById('clear-log-btn');
        
        const createProjectBtn = document.getElementById('create-project-btn');
        const listProjectsBtn = document.getElementById('list-projects-btn');
        const projectSelect = document.getElementById('project-select');
        const selectProjectBtn = document.getElementById('select-project-btn');
        
        const createEntityBtn = document.getElementById('create-entity-btn');
        const listEntitiesBtn = document.getElementById('list-entities-btn');
        const entitySelect = document.getElementById('entity-select');
        const getEntityBtn = document.getElementById('get-entity-btn');
        
        const toolNameInput = document.getElementById('tool-name');
        const toolArgsInput = document.getElementById('tool-args');
        const executeToolBtn = document.getElementById('execute-tool-btn');

        // Logging Functions
        function logMessage(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function logJSON(data, prefix = '', type = 'info') {
            logMessage(`${prefix}${JSON.stringify(data, null, 2)}`, type);
        }

        // SSE Connection Management
        function connectSSE() {
            if (connected) {
                logMessage('Already connected', 'error');
                return;
            }

            const baseUrl = baseUrlInput.value.trim();
            sessionId = sessionIdInput.value.trim() || `debug-session-${Date.now()}`;
            sessionIdInput.value = sessionId;
            
            logMessage(`Connecting to ${baseUrl} with session ID: ${sessionId}`);
            connectionStatus.textContent = 'Status: Connecting...';

            try {
                // Close any existing connection
                if (sseConnection) {
                    sseConnection.close();
                    sseConnection = null;
                }
                
                // Create new connection
                sseConnection = new EventSource(`${baseUrl}?sessionId=${sessionId}`);
                
                // Set a connection timeout
                const connectionTimeout = setTimeout(() => {
                    if (!connected) {
                        logMessage('Connection timeout - server not responding', 'error');
                        if (sseConnection) {
                            sseConnection.close();
                            sseConnection = null;
                        }
                        setConnectedState(false);
                    }
                }, 10000);
                
                // Standard EventSource events
                sseConnection.onopen = (event) => {
                    logMessage('SSE connection opened', 'success');
                    // Note: This doesn't mean we're fully connected yet
                    // We'll wait for the 'connected' event from the server
                };
                
                sseConnection.onmessage = (event) => {
                    logMessage(`Received message: ${event.data}`, 'info');
                    try {
                        const data = JSON.parse(event.data);
                        handleSSEEvent(data);
                    } catch (e) {
                        logMessage(`Error parsing SSE data: ${e.message}`, 'error');
                    }
                };
                
                // Custom server events
                sseConnection.addEventListener('connected', (event) => {
                    clearTimeout(connectionTimeout);
                    try {
                        const data = JSON.parse(event.data);
                        logJSON(data, 'Connection confirmed: ', 'success');
                        setConnectedState(true);
                    } catch (e) {
                        logMessage(`Error handling connected event: ${e.message}`, 'error');
                    }
                });
                
                sseConnection.addEventListener('response', (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        logJSON(data, 'Response event: ', 'success');
                        
                        if (data.id && responseHandlers[data.id]) {
                            responseHandlers[data.id](data);
                            delete responseHandlers[data.id];
                        }
                    } catch (e) {
                        logMessage(`Error handling response: ${e.message}`, 'error');
                    }
                });
                
                sseConnection.onerror = (event) => {
                    logMessage('SSE connection error', 'error');
                    clearTimeout(connectionTimeout);
                    setConnectedState(false);
                };
            } catch (e) {
                logMessage(`Error creating SSE connection: ${e.message}`, 'error');
                setConnectedState(false);
            }
        }

        function disconnectSSE() {
            if (sseConnection) {
                sseConnection.close();
                sseConnection = null;
            }
            setConnectedState(false);
            logMessage('Disconnected from SSE', 'info');
        }

        function setConnectedState(isConnected) {
            connected = isConnected;
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            createProjectBtn.disabled = !isConnected;
            listProjectsBtn.disabled = !isConnected; 
            executeToolBtn.disabled = !isConnected;
            createEntityBtn.disabled = !isConnected || !currentProjectId;
            listEntitiesBtn.disabled = !isConnected || !currentProjectId;
            
            connectionStatus.textContent = `Status: ${isConnected ? 'Connected' : 'Disconnected'}`;
            connectionStatus.style.color = isConnected ? '#5cb85c' : '#d9534f';
        }

        function handleSSEEvent(data) {
            // Generic event handler - can be expanded
            logJSON(data, 'SSE event: ');
        }

        // MCP Tool Functions
        function callTool(toolName, args = {}) {
            if (!connected) {
                logMessage('Cannot call tool: not connected', 'error');
                return null;
            }
            
            const requestId = `req-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            const payload = {
                type: 'request',
                id: requestId,
                tool: toolName,
                args: args
            };
            
            logJSON(payload, `Calling tool ${toolName}: `);
            
            return new Promise((resolve, reject) => {
                // Register handler for this request
                responseHandlers[requestId] = (response) => {
                    resolve(response);
                };
                
                // Send request
                fetch(`${baseUrlInput.value}?sessionId=${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network error: ${response.status}`);
                    }
                    logMessage(`Request for ${toolName} sent successfully`, 'success');
                })
                .catch(error => {
                    delete responseHandlers[requestId];
                    logMessage(`Error sending request: ${error.message}`, 'error');
                    reject(error);
                });
                
                // Set timeout
                setTimeout(() => {
                    if (responseHandlers[requestId]) {
                        delete responseHandlers[requestId];
                        reject(new Error('Request timed out'));
                        logMessage(`Request for ${toolName} timed out`, 'error');
                    }
                }, 10000);
            });
        }

        // Project Operations
        function createProject() {
            const projectName = `TestProject-${Date.now()}`;
            
            callTool('create_project', {
                name: projectName,
                description: `Test project created at ${new Date().toLocaleString()}`
            })
            .then(response => {
                if (response.isError) {
                    throw new Error(response.content[0].text);
                }
                
                try {
                    const projectData = JSON.parse(response.content[0].text);
                    logJSON(projectData, 'Project created: ', 'success');
                    
                    // Update project selection
                    listProjects();
                } catch (e) {
                    logMessage(`Error parsing project data: ${e.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`Error creating project: ${error.message}`, 'error');
            });
        }

        function listProjects() {
            callTool('list_projects', {})
            .then(response => {
                if (response.isError) {
                    throw new Error(response.content[0].text);
                }
                
                try {
                    const projectsData = JSON.parse(response.content[0].text);
                    projects = projectsData;
                    logJSON(projectsData, 'Projects: ', 'success');
                    
                    // Update project selection dropdown
                    updateProjectDropdown(projectsData);
                } catch (e) {
                    logMessage(`Error parsing projects data: ${e.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`Error listing projects: ${error.message}`, 'error');
            });
        }

        function selectProject() {
            const projectId = projectSelect.value;
            if (!projectId) {
                logMessage('No project selected', 'error');
                return;
            }
            
            callTool('select_project', {
                project_id: projectId
            })
            .then(response => {
                if (response.isError) {
                    throw new Error(response.content[0].text);
                }
                
                currentProjectId = projectId;
                logMessage(`Project selected: ${projectId}`, 'success');
                
                // Enable entity operations
                createEntityBtn.disabled = false;
                listEntitiesBtn.disabled = false;
            })
            .catch(error => {
                logMessage(`Error selecting project: ${error.message}`, 'error');
            });
        }

        function updateProjectDropdown(projects) {
            projectSelect.innerHTML = '<option value="">-- Select a project --</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.id})`;
                projectSelect.appendChild(option);
            });
            
            projectSelect.disabled = projects.length === 0;
            selectProjectBtn.disabled = projects.length === 0;
        }

        // Entity Operations
        function createEntity() {
            if (!currentProjectId) {
                logMessage('No project selected', 'error');
                return;
            }
            
            const entityName = `TestEntity-${Date.now()}`;
            
            callTool('create_entity', {
                name: entityName,
                type: 'test',
                description: `Test entity created at ${new Date().toLocaleString()}`
            })
            .then(response => {
                if (response.isError) {
                    throw new Error(response.content[0].text);
                }
                
                try {
                    const entityData = JSON.parse(response.content[0].text);
                    logJSON(entityData, 'Entity created: ', 'success');
                    
                    // Update entity list
                    listEntities();
                } catch (e) {
                    logMessage(`Error parsing entity data: ${e.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`Error creating entity: ${error.message}`, 'error');
            });
        }

        function listEntities() {
            if (!currentProjectId) {
                logMessage('No project selected', 'error');
                return;
            }
            
            callTool('list_entities', {})
            .then(response => {
                if (response.isError) {
                    throw new Error(response.content[0].text);
                }
                
                try {
                    const entitiesData = JSON.parse(response.content[0].text);
                    entities = entitiesData;
                    logJSON(entitiesData, 'Entities: ', 'success');
                    
                    // Update entity dropdown
                    updateEntityDropdown(entitiesData);
                } catch (e) {
                    logMessage(`Error parsing entities data: ${e.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`Error listing entities: ${error.message}`, 'error');
            });
        }

        function getEntity() {
            const entityId = entitySelect.value;
            if (!entityId) {
                logMessage('No entity selected', 'error');
                return;
            }
            
            callTool('get_entity', {
                id: entityId
            })
            .then(response => {
                if (response.isError) {
                    throw new Error(response.content[0].text);
                }
                
                try {
                    const entityData = JSON.parse(response.content[0].text);
                    logJSON(entityData, 'Entity details: ', 'success');
                } catch (e) {
                    logMessage(`Error parsing entity details: ${e.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`Error getting entity: ${error.message}`, 'error');
            });
        }

        function updateEntityDropdown(entities) {
            entitySelect.innerHTML = '<option value="">-- Select an entity --</option>';
            
            entities.forEach(entity => {
                const option = document.createElement('option');
                option.value = entity.id;
                option.textContent = `${entity.name} (${entity.type})`;
                entitySelect.appendChild(option);
            });
            
            entitySelect.disabled = entities.length === 0;
            getEntityBtn.disabled = entities.length === 0;
        }

        // Custom Tool Execution
        function executeCustomTool() {
            const toolName = toolNameInput.value.trim();
            if (!toolName) {
                logMessage('Tool name is required', 'error');
                return;
            }
            
            let args = {};
            try {
                const argsText = toolArgsInput.value.trim();
                if (argsText) {
                    args = JSON.parse(argsText);
                }
            } catch (e) {
                logMessage(`Invalid JSON arguments: ${e.message}`, 'error');
                return;
            }
            
            callTool(toolName, args)
            .then(response => {
                logJSON(response, `Response for ${toolName}: `, 'success');
            })
            .catch(error => {
                logMessage(`Error executing tool: ${error.message}`, 'error');
            });
        }

        // Event Listeners
        connectBtn.addEventListener('click', connectSSE);
        disconnectBtn.addEventListener('click', disconnectSSE);
        clearLogBtn.addEventListener('click', () => { logOutput.innerHTML = ''; });
        
        createProjectBtn.addEventListener('click', createProject);
        listProjectsBtn.addEventListener('click', listProjects);
        selectProjectBtn.addEventListener('click', selectProject);
        
        createEntityBtn.addEventListener('click', createEntity);
        listEntitiesBtn.addEventListener('click', listEntities);
        getEntityBtn.addEventListener('click', getEntity);
        
        executeToolBtn.addEventListener('click', executeCustomTool);

        // Initialize
        logMessage('MCP Debug Inspector initialized');
    </script>
</body>
</html> 